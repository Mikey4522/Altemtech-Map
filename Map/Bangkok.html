<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bangkok Projects â€” Featured Thumbs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet + noUiSlider -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.css"/>

  <style>
    :root{
      --year-box-offset: 120px;     /* keep slider where it is */
      --outline-weight: 2;          /* match Thailand thickness */

      --district-stroke:#cfd8e3;    /* thin inner district lines */
      --outside-bg:#f6f7fb;         /* outside Bangkok mask color */
      --outline-blue:#2f6bff;       /* Bangkok outer outline */
    }
    html, body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #map {
      height: 100svh;  /* mobile-safe viewport height */
      min-height: 100vh;
      width: 100%;
      background: var(--outside-bg);
    }

    /* Year control (unchanged placement) */
    .leaflet-top.leaflet-left .year-control { margin-left: var(--year-box-offset); }
    .year-control{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:10px; width:200px; box-shadow:0 8px 24px rgba(0,0,0,.08); line-height:1.1;
      margin:10px;
    }
    .year-control h4{ margin:0 0 8px; font-size:13px; font-weight:700; }
    .row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
    .row label{ font-size:12px; color:#374151; width:36px; }
    .row input[type="number"]{ width:90px; padding:6px 8px; font-size:12px; border:1px solid #d1d5db; border-radius:8px; }
    #yearSlider{ margin:6px 0 2px; }
    button{ width:100%; margin-top:6px; padding:7px 10px; font-size:12px; border:1px solid #d1d5db; border-radius:8px; background:#f9fafb; cursor:pointer; }
    button:hover{ background:#f3f4f6; }

    /* Legend (unchanged) */
    .leaflet-control.legend { background:transparent; border:0; box-shadow:none; margin-top:72px; margin-right:10px; }
    .legend-box{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.08); font-size:12px;
    }
    .legend-item{ display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend-swatch{ width:12px; height:12px; border-radius:999px; display:inline-block; box-shadow:0 0 0 2px rgba(0,0,0,.04) inset; }

    /* Featured (photo) markers */
    .leaflet-marker-icon.thumb-pin {
      width: 20px; height: 20px; border-radius: 50%;
      border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,.25);
      background-size: cover; background-position: center center;
      transition: transform .08s ease;
    }
    .leaflet-marker-icon.thumb-pin:hover { transform: scale(1.06); }

    /* Phone-only shrink (keeps anchors, reduces overlap) */
    @media (max-width: 640px) {
      :root { --ui-scale: 0.86; }
      .leaflet-top.leaflet-left .year-control { margin-left: calc(var(--year-box-offset) * var(--ui-scale)); }
      .year-control { transform: scale(var(--ui-scale)); transform-origin: top left; width: calc(200px * var(--ui-scale)); }
      .year-control .row label { font-size: 11px; }
      .year-control input[type="number"] { width: calc(90px * var(--ui-scale)); font-size: 11px; padding: 5px 6px; }
      #yearSlider { margin-top: 4px; }
      .noUi-tooltip { display: none !important; }
      .leaflet-control.legend { margin-top: 64px; }
      .legend-box { transform: scale(0.9); transform-origin: top right; font-size: 11px; padding: 8px 10px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    /* Legend colors */
    const CATEGORY_STYLE = {
      "D-wall":     { fill:"#ff6a3d", stroke:"#cc4d22", label:"D-wall" },
      "Pile-wall":  { fill:"#10b981", stroke:"#0e8967", label:"Pile-wall" },
      "Sheet Pile": { fill:"#6366f1", stroke:"#4348c9", label:"Sheet Pile" }
    };
    function addLegend(map){
      const Legend = L.Control.extend({
        options:{ position:"topright" },
        onAdd(){
          const root = L.DomUtil.create("div","leaflet-control legend");
          const box  = L.DomUtil.create("div","legend-box", root);
          box.innerHTML = Object.values(CATEGORY_STYLE).map(s =>
            `<div class="legend-item">
               <span class="legend-swatch" style="background:${s.fill}; border:1px solid ${s.stroke}"></span>
               <span>${s.label}</span>
             </div>`
          ).join("");
          L.DomEvent.disableClickPropagation(root);
          L.DomEvent.disableScrollPropagation(root);
          return root;
        }
      });
      map.addControl(new Legend());
    }

    /* Featured thumbnails (PNG files in the same folder) */
    const FEATURED_IMAGES = {
      "One City Centre (OCC)": "OCC.png",
      "One Bangkok":           "OB.png",
      "140 Wireless":          "140W.png"
    };
    const isFeatured = (p) => Object.prototype.hasOwnProperty.call(FEATURED_IMAGES, p.name);

    /* Data */
    const CURRENT_YEAR = new Date().getFullYear();
    const site = 'https://altemtech.com/portfolio-items/';
    const projects = [
      { name:"True Digital Park (Phase II)", lat:13.685581, lng:100.611308, start:2019, end:2021, type:"D-wall",     url:site+"true-digital-park-phase-ii/" },
      { name:"Emsphere & Emlive",           lat:13.732166, lng:100.566047, start:2018, end:2018, type:"D-wall",     url:site+"emsphere-emlive/" },
      { name:"One City Centre (OCC)",       lat:13.743039, lng:100.546853, start:2019, end:2021, type:"D-wall",     url:site+"one-city-centre/" },
      { name:"One Bangkok",                 lat:13.726830, lng:100.547200, start:2018, end:2021, type:"D-wall",     url:site+"one-bangkok/" },
      { name:"140 Wireless",                lat:13.739300, lng:100.546900, start:2020, end:2020, type:"D-wall",     url:site+"140-wireless/" },
      { name:"The New National Parliament House", lat:13.795823, lng:100.517282, start:2014, end:2016, type:"Pile-wall",  url:site+"the-new-national-parliament-house/" },
      { name:"BITEC (Bangna)",              lat:13.669170, lng:100.610000, start:2011, end:2014, type:"Pile-wall",  url:site+"bitec/" },
      { name:"TPP Healthcare International",lat:13.721886, lng:100.556262, start:2018, end:2019, type:"D-wall",     url:site+"tpp-healthcare-international-hospital/" },
      { name:"Terminal 21 (Asok)",          lat:13.737000, lng:100.560600, start:2008, end:2009, type:"D-wall",     url:site+"terminal-21/" },
      { name:"Siam Square One",             lat:13.739990, lng:100.526550, start:2012, end:2012, type:"Pile-wall",  url:site+"sindhorn-midtown/" },
      { name:"Rosewood Hotel Bangkok",      lat:13.744640, lng:100.548640, start:2015, end:2016, type:"D-wall",     url:site+"rosewood-bangkok/" },
      { name:"Muang Thai Life Assurance Head Office", lat:13.780000, lng:100.573000, start:2019, end:CURRENT_YEAR, type:"Sheet Pile", url:site+"muang-thai-life-assurance-head-office/" },
      { name:"THE UNICORN (Phaya Thai)",    lat:13.756000, lng:100.533000, start:2018, end:CURRENT_YEAR, type:"D-wall", url:site+"the-unicorn/" },
      { name:"MRT Connection (Samyan)",     lat:13.734000, lng:100.529000, start:2019, end:2019, type:"Sheet Pile", url:site+"mrt-connection-samyan/" },
      { name:"UOB Head Office (Sathon)",    lat:13.720448, lng:100.527311, start:2018, end:CURRENT_YEAR, type:"D-wall", url:site+"uob-head-office/" },
      { name:"Sindhorn Midtown",            lat:13.741388, lng:100.542920, start:2016, end:2017, type:"D-wall",     url:site+"sindhorn-midtown/" },
      { name:"Four Seasons Private Residences Bangkok", lat:13.700803, lng:100.492336, start:2015, end:2018, type:"Pile-wall", url:site+"four-seasons-private-residence/" },
      { name:"Carpark Shrewsbury (Riverside)", lat:13.709720, lng:100.509170, start:2018, end:2018, type:"D-wall", url:"https://altemtech.com/portfolio-items/%E0%B8%AD%E0%B8%B2%E0%B8%84%E0%B8%B2%E0%B8%A3%E0%B9%8C%E0%B8%88%E0%B8%AD%E0%B8%94%E0%B8%A3%E0%B8%96%E0%B9%82%E0%B8%A3%E0%B8%87%E0%B9%80%E0%B8%A3%E0%B8%B5%E0%B8%A2%E0%B8%99%E0%B8%99%E0%B8%B2%E0%B8%99%E0%B8%B2/?lang=th" }
    ];

    const map = L.map('map', { zoomSnap:0.25, attributionControl:false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { subdomains:'abcd', maxZoom:19 }).addTo(map);

    /* Panes */
    map.createPane('maskPane');     map.getPane('maskPane').style.zIndex = 350;
    map.createPane('fillPane');     map.getPane('fillPane').style.zIndex = 410;
    map.createPane('districtPane'); map.getPane('districtPane').style.zIndex = 420;
    map.createPane('outlinePane');  map.getPane('outlinePane').style.zIndex = 600;
    map.createPane('dotPane');      map.getPane('dotPane').style.zIndex = 650;

    const canvasRenderer = L.canvas({ padding:0.5 });
    const dotLayer = L.layerGroup().addTo(map);
    const featuredLayer = L.layerGroup().addTo(map);

    /* Build basemap + mask + smooth outline */
    fetch('bangkok-districts.geojson')
      .then(r => r.json())
      .then(bkkDistricts => {
        // Subtle district lines
        L.geoJSON(bkkDistricts, {
          pane:'districtPane', renderer:canvasRenderer, interactive:false,
          style:{ color:getCSS('--district-stroke'), weight:0.8, opacity:0.9, fillOpacity:0 }
        }).addTo(map);

        // Merge â†’ round corners â†’ simplify
        const fc = (bkkDistricts.type === 'FeatureCollection') ? bkkDistricts
                  : { type:'FeatureCollection', features:[bkkDistricts] };
        let merged = fc.features[0];
        for (let i=1;i<fc.features.length;i++) merged = turf.union(merged, fc.features[i]);
        const rounded = turf.buffer(turf.buffer(merged, 0.1, {units:'kilometers'}), -0.25, {units:'kilometers'});
        const simplified = turf.simplify(rounded, { tolerance:0.0004, highQuality:true });

        // Outer ring only for outline
        const outer = JSON.parse(JSON.stringify(simplified));
        if (outer.geometry.type === 'Polygon') outer.geometry.coordinates = [outer.geometry.coordinates[0]];
        else if (outer.geometry.type === 'MultiPolygon') outer.geometry.coordinates = outer.geometry.coordinates.map(poly => [poly[0]]);

        // Mask outside Bangkok
        L.geoJSON(turf.mask(simplified), {
          pane:'maskPane', renderer:canvasRenderer, interactive:false,
          style:{ stroke:false, fill:true, fillColor:getCSS('--outside-bg'), fillOpacity:1, fillRule:'evenodd' }
        }).addTo(map);

        // Light inner tint
        L.geoJSON(simplified, {
          pane:'fillPane', renderer:canvasRenderer, interactive:false,
          style:{ stroke:false, fill:true, fillColor:getCSS('--outline-blue'), fillOpacity:0.06 }
        }).addTo(map);

        // Thin, rounded blue outline â€” same weight as Thailand
        L.geoJSON(outer, {
          pane:'outlinePane', renderer:canvasRenderer, interactive:false, smoothFactor:2.5,
          style:{ color:getCSS('--outline-blue'), weight:parseFloat(getCSS('--outline-weight'))||2, opacity:1, lineJoin:'round', lineCap:'round', fill:false }
        }).addTo(map);

        /* Fit as before */
        const LEFT_UI_PAD = (parseInt(getCSS('--year-box-offset')) || 270) + 140;
        const baseBounds = L.geoJSON(outer).getBounds();
        map.fitBounds(baseBounds, { paddingTopLeft:[LEFT_UI_PAD,28], paddingBottomRight:[28,28] });

        /* ðŸ”§ More drag room when zoomed out (dynamic envelope) */
        const PAD_MIN = 0.22;   // tight when zoomed in
        const PAD_MAX = 0.70;   // generous when fully zoomed out

        function envelopeForZoom() {
          const zMin = map.getMinZoom();
          const zMax = map.getMaxZoom() || 19;
          const z    = map.getZoom();
          const t = Math.min(1, Math.max(0, (z - zMin) / (zMax - zMin))); // 0 at min zoom, 1 at max
          const pad = PAD_MAX - (PAD_MAX - PAD_MIN) * t; // more pad at low zoom
          return baseBounds.pad(pad);
        }
        function applyEnvelope() {
          const env = envelopeForZoom();
          map.setMaxBounds(env);
          map.panInsideBounds(env, { animate:true });
        }
        // initial + on interactions
        applyEnvelope();
        map.on('zoomend', applyEnvelope);
        map.on('resize', applyEnvelope);
        map.on('drag', () => map.panInsideBounds(envelopeForZoom(), { animate:true }));

        addYearControl();
        addLegend(map);
        initFilter();
      });

    function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

    function addYearControl(){
      const YearControl = L.Control.extend({
        options:{ position:'topleft' },
        onAdd(){
          const div = L.DomUtil.create('div','year-control');
          div.innerHTML =
            '<h4>Years</h4>' +
            '<div id="yearSlider"></div>' +
            '<div class="row"><label>From</label><input id="minYear" type="number" step="1"></div>' +
            '<div class="row"><label>To</label><input id="maxYear" type="number" step="1"></div>' +
            '<button id="applyBtn">Apply</button>';
          L.DomEvent.disableClickPropagation(div);
          L.DomEvent.disableScrollPropagation(div);
          return div;
        }
      });
      map.addControl(new YearControl());
    }

    function initFilter(){
      const years=[]; for (const p of projects){ years.push(p.start,p.end); }
      const dataMin=Math.min(...years), dataMax=Math.max(...years);

      const sliderEl=document.getElementById('yearSlider');
      const minInput=document.getElementById('minYear');
      const maxInput=document.getElementById('maxYear');
      const applyBtn=document.getElementById('applyBtn');

      minInput.value=dataMin; minInput.min=dataMin; minInput.max=dataMax;
      maxInput.value=dataMax; maxInput.min=dataMin; maxInput.max=dataMax;

      noUiSlider.create(sliderEl,{ start:[dataMin,dataMax], connect:true, step:1, range:{min:dataMin,max:dataMax}, tooltips:[true,true], behaviour:'drag' });

      sliderEl.noUiSlider.on('update', vals=>{
        const lo=Math.round(+vals[0]), hi=Math.round(+vals[1]);
        minInput.value=lo; maxInput.value=hi; drawDots(lo,hi);
      });

      applyBtn.addEventListener('click', ()=>{
        let lo=parseInt(minInput.value,10), hi=parseInt(maxInput.value,10);
        if (isNaN(lo)) lo=dataMin; if (isNaN(hi)) hi=dataMax;
        lo=Math.max(dataMin,Math.min(lo,dataMax));
        hi=Math.max(dataMin,Math.min(hi,dataMax));
        if (lo>hi) [lo,hi]=[hi,lo];
        sliderEl.noUiSlider.set([lo,hi]);
      });

      drawDots(dataMin,dataMax);
    }

    function jitterLatLng(lat,lng,meters=100){
      const t=Math.random(), phi=(Math.sqrt(5)-1)/2, angle=2*Math.PI*(t/phi);
      const r=meters*(0.3+0.7*Math.random());
      const dLat=(r/111320)*Math.cos(angle), dLng=(r/(111320*Math.cos(lat*Math.PI/180)))*Math.sin(angle);
      return [lat+dLat, lng+dLng];
    }

    function drawDots(minYear,maxYear){
      dotLayer.clearLayers();
      featuredLayer.clearLayers();

      for (const p of projects){
        if (!(p.end>=minYear && p.start<=maxYear)) continue;

        if (isFeatured(p)) {
          const icon = L.divIcon({ className:'thumb-pin', html:'', iconSize:[20,20], iconAnchor:[10,10] });
          const mk = L.marker([p.lat, p.lng], { icon, zIndexOffset:1000 })
            .addTo(featuredLayer)
            .bindPopup(
              `<div class="popup-title"><a href="${p.url||'#'}" target="_blank" rel="noopener noreferrer">${p.name}</a></div>`+
              `<small>${p.start}${p.start!==p.end?'â€“'+p.end:''} â€¢ ${p.type}</small>`
            );
          mk.on('add', () => {
            const el = mk.getElement();
            if (el) el.style.backgroundImage = `url("${FEATURED_IMAGES[p.name]}")`;
          });
          setTimeout(() => {
            const el = mk.getElement();
            if (el && !el.style.backgroundImage) el.style.backgroundImage = `url("${FEATURED_IMAGES[p.name]}")`;
          }, 0);
          if (p.url) mk.on('dblclick',()=>window.open(p.url,'_blank','noopener,noreferrer'));
        } else {
          const [lat,lng] = jitterLatLng(p.lat,p.lng,100);
          const sty = CATEGORY_STYLE[p.type] || CATEGORY_STYLE["D-wall"];
          L.circleMarker([lat, lng], {
            pane:'dotPane', radius:7, weight:1, color:sty.stroke, fillColor:sty.fill, fillOpacity:0.98
          })
          .addTo(dotLayer)
          .bindPopup(
            `<div class="popup-title"><a href="${p.url||'#'}" target="_blank" rel="noopener noreferrer">${p.name}</a></div>`+
            `<small>${p.start}${p.start!==p.end?'â€“'+p.end:''} â€¢ ${p.type}</small>`
          )
          .on('dblclick',()=>{ if (p.url) window.open(p.url,'_blank','noopener,noreferrer'); });
        }
      }

      featuredLayer.bringToFront();
      dotLayer.bringToFront();
    }
  </script>
</body>
</html>
